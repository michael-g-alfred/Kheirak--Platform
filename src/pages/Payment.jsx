import React, { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { loadStripe } from "@stripe/stripe-js";
import { Elements } from "@stripe/react-stripe-js";
import { toast } from "react-hot-toast";
import {
  doc,
  updateDoc,
  arrayUnion,
  getDoc,
  setDoc,
  collection,
  serverTimestamp,
  addDoc,
} from "firebase/firestore";
import { db } from "../Firebase/Firebase";
import InputField from "../components/InputField";
import SubmitButton from "../components/SubmitButton";
import PaymentModal from "../components/PaymentModal";
import PageLayout from "../layouts/PageLayout";
import FormLayout from "../layouts/FormLayout";
import Loader from "../components/Loader";
import Divider from "../components/Divider";

// Initialize Stripe
// To use this, create a .env file in your project root and add:
// VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_actual_key_here
const stripePublishableKey =
  "pk_test_51Rw3aJKqx1jQOopCOqMxQzaDYgoO4cgAyhjElDvwD5a3iHZ87MW3o54apgr5qpgtPNWVRgBhAlPR92Fph6X8dhGX00DBTr4ltD";
const stripePromise = loadStripe(stripePublishableKey);

export default function Payment() {
  const navigate = useNavigate();
  const location = useLocation();
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [donationData, setDonationData] = useState(null);

  const [form, setForm] = useState({
    cardNumber: "",
    expiry: "",
    cvv: "",
    firstName: "",
    lastName: "",
    country: "ูุตุฑ",
    vatId: "",
  });

  useEffect(() => {
    // Get donation data from navigation state
    const navDonationData = location.state?.donationData;
    if (navDonationData) {
      setDonationData(navDonationData);
    } else {
      // If no donation data, redirect to home
      toast.error("ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุจุฑุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
      navigate("/");
    }
  }, [location.state, navigate]);

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    // Validate required fields
    if (!form.firstName || !form.lastName) {
      toast.error("ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ุงูุฃูู ูุงุณู ุงูุนุงุฆูุฉ");
      return;
    }

    // Show Stripe payment modal
    setShowPaymentModal(true);
  };

  const handlePaymentSuccess = async () => {
    if (!donationData) {
      toast.error("ุฎุทุฃ ูู ุจูุงูุงุช ุงูุชุจุฑุน");
      return;
    }

    setShowPaymentModal(false);

    // Reset form
    setForm({
      cardNumber: "",
      expiry: "",
      cvv: "",
      firstName: "",
      lastName: "",
      country: "ูุตุฑ",
      vatId: "",
    });

    // Check if this is a campaign coupon purchase
    if (donationData.donationType === "campaign_coupon") {
      // Handle campaign coupon purchase
      await handleCampaignCouponPurchase();
    } else {
      // Handle regular donation
      await handleRegularDonation();
    }
  };

  const handleCampaignCouponPurchase = async () => {
    // Show success message for coupon purchase
    toast.dismiss();
    toast.success(
      `ุชู ุดุฑุงุก ุงูููุจูู ุจูุฌุงุญ! ุฏูุนุช ${donationData.donationAmount} ุฌ.ู`,
      {
        duration: 3000,
      }
    );

    // Try to create coupon in database
    try {
      const couponsCol = collection(db, "Coupons");
      const docRef = doc(couponsCol);

      const newCoupon = {
        id: docRef.id,
        ...donationData.couponData,
        timestamp: serverTimestamp(),
      };

      await setDoc(docRef, newCoupon);

      // Send notification to user about coupon creation
      if (
        donationData.couponData.submittedBy.email &&
        donationData.couponData.submittedBy.email !== "unknown@kheirak"
      ) {
        await addDoc(
          collection(
            db,
            "Notifications",
            donationData.couponData.submittedBy.email,
            "user_Notifications"
          ),
          {
            title: "ุชู ุฅูุดุงุก ููุจููู",
            message: `ุชู ุฅูุดุงุก ููุจูู ${donationData.campaignInfo.item.name} ููู ุงูุขู ููุฏ ุงููุฑุงุฌุนุฉ`,
            imageUrl: donationData.campaignInfo.item.image || "",
            imageAlt: donationData.campaignInfo.item.name,
            timestamp: Date.now(),
          }
        );
      }
    } catch (error) {
      console.error("Database update error (payment was successful):", error);
      toast.error(
        "ุชู ุงูุฏูุน ุจูุฌุงุญ ูููู ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงูููุจูู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฏุนู."
      );
    }
  };

  const handleRegularDonation = async () => {
    // Show success message for regular donation
    toast.dismiss();
    toast.success(
      ` ุชู ุงูุฏูุน ูุงูุชุจุฑุน ุจูุฌุงุญ! ุชุจุฑุนุช ุจู ${donationData.donationAmount} ุฌ.ู`,
      {
        duration: 3000,
      }
    );

    // Try to update database in the background
    try {
      const {
        postId,
        donationAmount,
        totalRequired,
        currentTotal,
        donor,
        recipient,
        postTitle,
      } = donationData;

      const newTotal = currentTotal + donationAmount;
      const postRef = doc(db, "Posts", postId);

      // Update post with donation
      const updateData = {
        totalDonated: newTotal,
        donors: arrayUnion({
          email: donor.email,
          uid: donor.uid,
          amount: donationAmount,
          date: new Date().toISOString(),
        }),
        isCompleted: newTotal >= totalRequired,
      };

      if (newTotal >= totalRequired) {
        updateData.status = "ููุชูู";
      }

      await updateDoc(postRef, updateData);

      // Send notification to donor
      const donorNotifRef = doc(
        db,
        "Notifications",
        donor.email,
        "user_Notifications",
        `${Date.now()}`
      );

      await setDoc(donorNotifRef, {
        title: "ุดูุฑูุง ุนูู ุชุจุฑุนู",
        message: `ููุฏ ุชุจุฑุนุช ุจูุจูุบ ${donationAmount} ุฌููู ููุทูุจ ${postTitle}`,
        timestamp: new Date().toISOString(),
        read: false,
        userId: donor.uid,
      });

      // Send notification to recipient
      if (recipient.email) {
        const ownerNotifRef = doc(
          db,
          "Notifications",
          recipient.email,
          "user_Notifications",
          `${Date.now() + 1}`
        );

        await setDoc(ownerNotifRef, {
          title: "ุชู ุงุณุชูุงู ุชุจุฑุน ุฌุฏูุฏ",
          message: `${donor.email} ุชุจุฑุน ูู ุจูุจูุบ ${donationAmount} ุฌููู.`,
          timestamp: new Date().toISOString(),
          read: false,
          userId: recipient.id,
        });
      }

      // If donation target is reached, send completion notifications
      if (newTotal >= totalRequired) {
        const snapshot = await getDoc(postRef);
        const data = snapshot.data();

        const donorMap = (data?.donors || []).reduce((acc, d) => {
          if (d.email && !acc[d.email]) {
            acc[d.email] = d.uid || "unknown";
          }
          return acc;
        }, {});

        // Notify all donors about completion
        for (const [email, uid] of Object.entries(donorMap)) {
          const notificationRef = doc(
            db,
            "Notifications",
            email,
            "user_Notifications",
            `${Date.now() + Math.floor(Math.random() * 1000)}`
          );

          await setDoc(notificationRef, {
            title: "ุดูุฑูุง ุนูู ุชุจุฑุนู ๐",
            message: `ุดูุฑุงู ูู! ุชู ุงููุตูู ููุฏู ุงูุชุจุฑุน ููุทูุจ: ${postTitle}.`,
            timestamp: new Date().toISOString(),
            read: false,
            userId: uid,
          });
        }

        // Send QR code to recipient
        if (recipient.email) {
          const qrData = JSON.stringify({
            postId,
            title: postTitle,
            amount: totalRequired,
            totalDonated: newTotal,
            submittedBy: recipient,
          });

          const qrCodeURL = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(
            qrData
          )}&size=150x150`;

          const qrNotificationRef = doc(
            db,
            "Notifications",
            recipient.email,
            "user_Notifications",
            `${Date.now() + 2}`
          );

          await setDoc(qrNotificationRef, {
            title: "ุงูุชูู ุฌูุน ุงูุชุจุฑุนุงุช ๐",
            message: `ุชู ุงูุชูุงู ุฌูุน ุงูุชุจุฑุนุงุช ูุทูุจู "${postTitle}". ูุฐุง ูู ุฑูุฒ ุงูุงุณุชุฌุงุจุฉ ุงูุณุฑูุนุฉ ุงูุฐู ูุญุชูู ุนูู ุชูุงุตูู ุงูุทูุจ.`,
            imageUrl: qrCodeURL,
            timestamp: new Date().toISOString(),
            read: false,
            userId: recipient.id,
          });
        }
      }
    } catch (error) {
      // Silently log the error but don't show error to user since payment succeeded
      console.error("Database update error (payment was successful):", error);
    }
  };

  const handlePaymentError = (error) => {
    toast.error(`ุฎุทุฃ ูู ุงูุฏูุน: ${error.message}`);
  };

  const handleCloseModal = () => {
    setShowPaymentModal(false);
  };

  return (
    <PageLayout>
      {/* ููุฑู ุงูุฏูุน ูููุฎุต ุงูุณูุฉ ูู ุดุจูุฉ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-2">
        <FormLayout formTitle={"ุฃุฏุฎู ุจูุงูุงุช ุงูุฏูุน"}>
          <form className="space-y-2" onSubmit={handleSubmit}>
            <InputField
              label="ุงูุงุณู ุงูุฃูู"
              id="firstName"
              name="firstName"
              value={form.firstName}
              onChange={handleChange}
              placeholder="ุงูุงุณู ุงูุฃูู"
              required
            />
            <InputField
              label="ุงุณู ุงูุนุงุฆูุฉ"
              id="lastName"
              name="lastName"
              value={form.lastName}
              onChange={handleChange}
              placeholder="ุงุณู ุงูุนุงุฆูุฉ"
              required
            />
            <InputField
              label="ุงูุฏููุฉ / ุงูููุทูุฉ"
              id="country"
              name="country"
              select={true}
              value={form.country}
              onChange={handleChange}
              options={[
                { label: "ูุตุฑ", value: "ูุตุฑ" },
                { label: "ุงูููุงูุงุช ุงููุชุญุฏุฉ", value: "ุงูููุงูุงุช ุงููุชุญุฏุฉ" },
                { label: "ุงูููููุฉ ุงููุชุญุฏุฉ", value: "ุงูููููุฉ ุงููุชุญุฏุฉ" },
                { label: "ุงูุฅูุงุฑุงุช", value: "ุงูุฅูุงุฑุงุช" },
              ]}
            />

            <SubmitButton buttonTitle="ูุชุงุจุนุฉ ููุฏูุน" />
          </form>
        </FormLayout>

        <FormLayout
          formTitle={
            donationData?.donationType === "campaign_coupon"
              ? "ุดุฑุงุก ููุจูู"
              : "ุชุจุฑุน ูุญููุฉ"
          }>
          {donationData ? (
            <div className="space-y-3 mb-6">
              {donationData.donationType === "campaign_coupon" ? (
                // Campaign coupon summary
                <div className="mb-4 p-3 rounded-lg border border-[var(--color-bg-divider)]">
                  <h4 className="font-medium text-[var(--color-primary-base)] mb-2">
                    ููุจูู {donationData.campaignInfo.item.name}
                  </h4>
                  <div className="text-sm text-[var(--color-bg-text-dark)] mb-2 space-y-1">
                    <p>ุญููุฉ: {donationData.campaignInfo.campaign.type}</p>
                    <p>ูุฆุฉ: {donationData.campaignInfo.category.name}</p>
                    <p>ุงูุนูุตุฑ: {donationData.campaignInfo.item.name}</p>
                  </div>
                </div>
              ) : (
                // Regular donation summary
                <div className="mb-4 p-3 bg-[var(--color-bg-base)] rounded-lg border border-[var(--color-bg-divider)]">
                  <h4 className="font-medium text-[var(--color-primary-base)] mb-2">
                    {donationData.postTitle}
                  </h4>
                  <div className="text-sm text-[var(--color-bg-text-dark)] mb-2 space-y-1">
                    {donationData.postDetails ? (
                      donationData.postDetails
                        .split("โข")
                        .map((detail, index) => (
                          <p key={index} className="leading-relaxed">
                            {detail.trim()}
                          </p>
                        ))
                    ) : (
                      <p>ุบูุฑ ูุนุฑู</p>
                    )}
                  </div>
                  <p className="text-xs text-[var(--color-bg-muted-text)]">
                    ูุตุงูุญ: {donationData.recipient.name}
                  </p>
                </div>
              )}
              <Divider />

              {/* Show quantity and unit price for campaign coupons */}
              {donationData.donationType === "campaign_coupon" && (
                <div className="flex flex-col gap-2">
                  <div className="flex justify-between">
                    <span className="text-[var(--color-bg-text-dark)]">
                      ุงููููุฉ
                    </span>
                    <span className="text-[var(--color-primary-base)] font-medium">
                      {donationData.campaignInfo.quantity}
                    </span>
                  </div>

                  <div className="flex justify-between">
                    <span className="text-[var(--color-bg-text-dark)]">
                      ุณุนุฑ ุงูููุจูู ุงููุงุญุฏ
                    </span>
                    <span className="text-[var(--color-primary-base)] font-medium">
                      {donationData.campaignInfo.item.price.toLocaleString()}{" "}
                      ุฌ.ู
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-[var(--color-bg-text-dark)]">
                      {donationData.donationType === "campaign_coupon"
                        ? "ุฅุฌูุงูู ุงููุจูุบ"
                        : "ูุจูุบ ุงูุชุจุฑุน"}
                    </span>
                    <span className="text-[var(--color-primary-base)] font-medium">
                      {donationData.donationAmount.toLocaleString()} ุฌ.ู
                    </span>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <Loader />
          )}

          <Divider />

          <div className="flex justify-between">
            <h3 className="text-lg font-bold text-[var(--color-primary-base)]">
              ุงูุฅุฌูุงูู:
            </h3>
            <h3 className="text-lg font-bold text-[var(--color-primary-base)]">
              {donationData
                ? donationData.donationAmount.toLocaleString()
                : "0"}{" "}
              ุฌ.ู
            </h3>
          </div>
        </FormLayout>
      </div>

      {/* Stripe Payment Modal */}
      {showPaymentModal && donationData && (
        <Elements stripe={stripePromise}>
          <PaymentModal
            amount={donationData.donationAmount}
            currency="egp"
            customerInfo={{
              firstName: form.firstName,
              lastName: form.lastName,
              country: form.country,
            }}
            onSuccess={handlePaymentSuccess}
            onError={handlePaymentError}
            onClose={handleCloseModal}
          />
        </Elements>
      )}
    </PageLayout>
  );
}
